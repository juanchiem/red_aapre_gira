---
title: "Genetica + densidad"
format: html
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = F, warning = FALSE, message = FALSE)

library(tidyverse) 
library(rio)
library(huxtable)
library(car)
library(broom)
# library(ggstance)
# library(patchwork)
library(lmerTest)
# library(nlme)
library(emmeans)
library(multcomp)
library(performance)
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflict_prefer("select", "dplyr")
theme_set(theme_bw(base_size = 12)) 
source(here::here("rinde_ajustado.R"))
```

```{r solo importar luego de updates de los datos, eval=FALSE}
library(googlesheets4)
gs4_deauth()
sheet_url <- "https://docs.google.com/spreadsheets/d/1PxPrPQmfVrJos_YyYkcqRf1fELkQptYuo0xMhJoifyY/edit?usp=sharing"

sheet_online <- sheet_url %>% gs4_get()

sheet_online %>% 
  range_read(sheet="gen_dens")%>% 
  janitor::clean_names()-> geno_dens_raw

geno_dens_raw %>% 
  mutate(across(c("hibrido", "sitio", "antecesor"), 
                ~stringi::stri_trans_general(
                  #pasar a mayusculas y sacar puntos
                  str_to_upper(gsub(',', '\\.', 
                                    # sacar espacios antes-desp
                                    str_trim(
                                      str_replace_all(., fixed(" "), "_")
                                    ))), "Latin-ASCII"))) %>% 
  mutate_at(vars(rendimiento, mat_grasa_mtra_limpia_sss, humedad_a_cosecha_percent), 
            as.numeric) %>% 
  mutate(hibrido = str_replace_all(hibrido, "INSUN_211CL", "INSUN_211_CL")) %>% 
  mutate(hibrido = str_replace_all(hibrido, "ACA_416_CLDM", "ACA_216_CLDM")) %>% 
  mutate(hibrido = str_replace_all(hibrido, "PARAISO_1800CP", "NUSOL_4180_CL_PLUS")) %>% 
  mutate(hibrido = str_replace_all(hibrido, "RGT_4260CL", "RAGT_4260_MAX-CL_G-2E")) %>% 
  mutate_at(vars(densidad), as.factor) %>% 
  drop_na(rendimiento, mat_grasa_mtra_limpia_sss) %>% 
  mutate(
    rinde_11 = ajustar_por_humedad(rendimiento,
                                   humedad_a_cosecha=humedad_a_cosecha_percent,
                                   hum_recibo = 11),
    rinde_bonificado = ajustar_por_aceite(rinde_11,
                                     aceite_porcen=mat_grasa_mtra_limpia_sss)) -> geno_dens 

geno_dens %>% rio::export("data/geno_densidad.csv")
```

```{r}
geno_dens <-rio::import("data/geno_densidad.csv")
```

## Sitios Experimentales 

```{r}
geno_dens %>% 
  distinct(sitio, .keep_all = T) %>% 
  select(responsable:fecha_de_siembra)
```

## Genética

```{r, eval=FALSE}
geno_dens %>% 
  count(hibrido) %>%
  arrange(n)
  

geno_dens %>% 
  filter(str_detect(ensayo, "gen")) %>%
  filter(str_detect(densidad, "Estandar")) %>%
  drop_na(rendimiento) %>% 
  xtabs(~ hibrido + sitio, .)
```

```{r geno: datos con densidad estandar, eval=FALSE}
geno_dens %>% 
  filter(str_detect(ensayo, "gen")) %>%
  filter(str_detect(densidad, "Estandar")) -> geno
```

### Análisis intra-localidad

```{r echo=FALSE, eval=TRUE, results='asis'}
rindes_plot <- map(
  geno %>% distinct(sitio) %>% pull(sitio), 
  ~ geno %>% 
    filter(str_detect(ensayo, "gen"), sitio==.x) %>% 
    ggplot() +
    aes(x=hibrido, y=rinde_bonificado)+
    geom_point() + 
    # facet_wrap("sitio", ncol = 2)+
    stat_summary(fun="mean", geom = "crossbar", width=.2, col="red") + 
    # stat_summary(fun=mean, aes(label=round(after_stat(y))), geom="text", size=3, vjust=-.5) + 
    coord_flip()+
    stat_summary(fun=mean, aes(label=round(after_stat(y))), geom="text", size=3, vjust=-.5) + 
    labs(title=.x)  
)
rindes_plot
```

```{r double-check sitio individual , eval=FALSE}
geno %>% 
  filter(sitio=="GUAMINI") %>% 
  arrange(hibrido)
```

#--------
# ACA VA EL ANOVA INTRA SITIO - SOLO PARA AQUELLOS CON RFANJAS REPETIDAS 
#--------

```{r}
geno %>% 
  count(sitio, hibrido) |> 
  group_by(sitio) |> 
  summarise(across(n, list(min = min, max = max)))
```

Sitios sin reps o con un solo hibrido repetido: `RIVERA`, `TANDIL`, `SALDUNGARAY`)

```{r}
mod_xloc <- geno |>
  filter(!sitio %in% c("RIVERA", "TANDIL", "SALDUNGARAY")) |> 
  group_nest(sitio) |> 
  mutate(
    m = map(data, ~ lm(rinde_bonificado ~ hibrido + repeticion, .x)),
    pval = map(m, ~ anova(.x) |> tidy() |> filter(term == "hibrido") |> pull(p.value)),
    emm = map(m, ~ emmeans(.x, ~ hibrido) |> tidy()), 
    sw = map(m, ~ resid(.x) |> shapiro.test() |> tidy() |> pull(p.value)),
    lv = map2(m, data, ~ leveneTest(resid(.x) ~ hibrido, .y) |> tidy() |> pull(p.value))
  ) |> 

mod_xloc |> 
  unnest(cols = c(pval, sw, lv)) |> 
  select(sitio, pval, sw, lv)
```

En algunos sitios no se cumplen los supuestos pero por otro lado, teniendo rep = 2 medo complicado. En general se detectan diferencias en la mayoría de los sitios.

A continuación una tabla con las medias estimadas por los modelos por localidad, se inclyen los sitios sin reps.

```{r}
geno2 <- mod_xloc |> 
  unnest(col = emm) |> 
  select(sitio, hibrido, estimate, std.error)
geno2
```


### Análisis multi-localidad

```{r}
geno %>% 
  count(hibrido) %>%
  filter(n>4) %>% 
  pull(hibrido) -> hibridos_para_analisis_global

geno %>% 
  filter(hibrido %in% hibridos_para_analisis_global)  %>% 
  count(hibrido) %>% 
  as_hux() %>% 
  set_font_size(9) %>% 
  theme_compact() %>% 
  set_tb_padding(.05)

geno %>% 
  filter(hibrido %in% hibridos_para_analisis_global) -> geno_multi

```

```{r}
geno_multi %>% 
  drop_na(rendimiento) %>% 
  xtabs(~ hibrido + sitio, .)
## FALTA PARAISO_1800_CL_PLUS en TRES ARROYOS CONTINENTAL, el resto esta al menos una vez

```

#--------
# ACA VA EL ANOVA INTER SITIO 
#--------


```{r}
# Modelo con interacción tratamiento factor
m0 <- lmerTest::lmer(
  rinde_bonificado ~ hibrido + (1 | hibrido:sitio) + (1|sitio/repeticion),
  data = geno_multi
)
plot(m0)
```

```{r}
check_homogeneity(m0)  # levene no anda
check_normality(m0, effects = "fixed") |> plot(type = "qq")
check_normality(m0, effects = "random") |> plot(type = "qq")
```

La normalidad bastante bien, salvo el efecto fijo un poco mas variable (desvios en los extremos).

```{r}
# Anova efectos fijos
anova(m0)
```

Segun esto diferencias entre hibridos globalmente

```{r}
# Anova efectos aleatorios
ranova(m0)
```

Los efectos aleatorios sin significativos. Interaccion hibrido sitio.

```{r}
VarCorr(m0)
```

Gran parte se lleva el sitio pero entre sitio y su interaccion con hibrido casi 75%.

Las medias globales de cada sitio:

```{r}
lsm <- emmeans(m0, ~hibrido)
lsm
```


```{r}
# Comaracion dosis individuales vs control
contrast(lsm, method = "trt.vs.ctrl", ref = "SYN_3970_CL") |> 
  as_tibble() |> 
  arrange(estimate)
```

EL hibrido de referencia le gana a los `CACIQUE` y `NUSOL`. Luego no difiere del resto.

```{r}
# Comaracion dosis individuales vs control
# contrast(lsm, method = "pairwise")
cld(lsm, reversed = T)
```

## Tabla coloreada

```{r}
source("create_tbl_genxloc.R")
create_tbl_genxloc(
  genotypes = hibrido,
  locations = sitio,
  response = estimate,
  data = geno2
)
```


## Densidad

```{r}
geno_dens %>% #count(ensayo)
  filter(str_detect(ensayo, "densidad")) -> densidad
```


```{r, fig.height=10}
densidad %>% 
    mutate(densidad=  fct_relevel(densidad, "Menos 30%", "Estandar", "Mas 30%")) %>% 
    ggplot() +
    aes(x=densidad, y=rinde_bonificado)+
    geom_point() + 
    facet_wrap("sitio", ncol = 2)+
    stat_summary(fun="mean", geom = "crossbar", width=.2, col="red") + 
    # stat_summary(fun=mean, aes(label=round(after_stat(y))), geom="text", size=3, vjust=-.5) + 
    # coord_flip()+
    stat_summary(fun=mean, aes(label=round(after_stat(y))), geom="text", size=3, vjust=-.5) +
    stat_summary(fun=mean, colour="red", geom="line", aes(group = 1))

```

### SOLO SYN_3970_CL (n=40)

```{r}
library(ggrepel)
geno_dens %>% #names %>% sort
  filter(hibrido=="SYN_3970_CL") %>% 
  ggplot() + 
  aes(x=plantas_ha, y=rinde_bonificado,col=sitio, group=1)+
  geom_point() + 
  geom_smooth(se=F, alpha=.1, col="grey70") +
  geom_text_repel(aes(label=sitio), size=2) +
  labs(title="Solo SYN_3970_CL") +
  guides(col="none")
```

```{r}
mod_dens_cat <- densidad |> 
  filter(sitio != "LA_PAMPA") |> 
  group_nest(sitio) |> 
  mutate(
    m_dens = map(data, ~ lm(rinde_bonificado ~ densidad, .x)),
    res = map(m_dens, ~ glance(.x))

  ) |> 
  unnest(res)
mod_dens_cat
```


```{r}
mod_pl <- densidad |> 
  filter(sitio != "LA_PAMPA") |> 
  group_nest(sitio) |> 
  mutate(
    m_pl = map(data, ~ lm(rinde_11 ~ plantas_ha, .x)),
    m_pl2 = map(data, ~ lm(rinde_11 ~ plantas_ha + I(plantas_ha**2), .x)),
    res = map(m_pl2, ~ glance(.x))
  ) |> 
  unnest(res)
mod_pl
```

```{r}
m_dens1 <- lm(rinde_bonificado ~ plantas_ha, densidad)
m_dens1 <- lm(rinde_bonificado ~ plantas_ha + I(plantas_ha^2), densidad |> filter(hibrido=="SYN_3970_CL")) 
m_dens2 <- lm(rinde_bonificado ~ sitio * (plantas_ha + I(plantas_ha^2)), densidad |>   filter(hibrido=="SYN_3970_CL")) 
anova(m_dens1, m_dens2)

compare_performance(m_dens1, m_dens2)
summary(m_dens2)
```

